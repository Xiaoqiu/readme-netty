chapter12 私有协议栈的开发
- 私有协议介绍
- 基于netty的私有协议栈设计
- 私有协议栈开发

- 传统Java应用，4种跨节点通信方式
    - 1 通过RMI进行远程服务调用
    - 2 通过Java的socket+Java序列化的方式
    - 3 使用开源的RPC框架进行远程服务调用，如，Thrift,Avro等
    - 4 利用标准的公有协议，如HTTP+XML, RESTful+JSON, WebService
    
- 跨节点的远程服务调用形成私有协议的元素：
    - 链路层的物理连接
    - 请求响应的编解码
    - 携带以下控制管理指令
        - 链路简历的握手请求和响应消息
        - 链路检测的心跳消息    
### 12.2.2 协议描述
- 使用netty提供的异步TCP协议栈开发一个私有协议：netty协议
    - 内部各个模块之间的通信
    - 基于TCP/IP协议栈，一个类HTTP协议的应用层协议栈
    - 没有客户端和服务端的区别  
    - 基于netty的NIO通信框架，提高性能的异步通信能力
    - 提供消息的编码解码框架，实现POJO的序列化和反序列化
    - 提供基于IP地址的白名单接入认证机制
    - 链路的有效性校验机制
    - 链路的断连重连机制
    
### 12.2.3 通信模型
    - 1 客户端：握手请求，携带节点ID,身份认证信息
    - 2 服务端：握手应答，节点ID有效性校验，节点重复登录校验，IP地址合法性校验，
    - 3 客户端：链路建立成功后，发送业务消息，
    - 4 服务端：链路成功之后，发送心跳消息
    - 5 客户端：链路建立成功后，发送心跳消息。链路空闲时，客户端主动发送Ping消息，服务端应答Pong,如果客户端连续发送N条Ping消息都没有接收到服务端返回的Pong消息，说明链路已经挂死或者对方处于异常状态，客户端主动关闭连接，
        - 间隔周期T后发起重连操作，知道重连成功。   
    - 6 服务端：链路建立成功后，发送业务消息
    - 7 服务端退出时，服务端关闭连接，
    - 8 客户端感知对方关闭连接，被动关闭客户端连接
    
    - 关闭连接 
 
 ### 12.2.4 消息定义  
 netty协议栈消息定义包含两部分：
 - 消息头：Header
 - 消息体：NettyMessage
 
- body的编码：JBoss Marchalling序列化为byte数组，然后使用ByteBuffer.put()写入ByteBuffer缓冲区
- body的解码： JBoss Marchalling

### 12.2.7 链路的建立
- 安全考虑：基于IP地址的安全认证。多个IP使用逗号分隔。
- 实际应用：通过密钥对用户名和密码进行安全认证。
- 握手请求消息：
    - 1 消息头的type=3
    - 2 可选附件个数=0
    - 3 消息体为空
    - 4 握手消息的长度22个字节
- 握手应答消息定义：
    - 1 消息头的type=4
    - 2 可选的附件个数=0
    - 3 消息体为type类型的结果，认证成功=0，认证失败=-1
   
### 12.2.8 链路关闭
- 才用长连接通信,正常业务运行期间，双方通过心跳和业务消息维持链路，任何一方不需要主动关闭连接。
- 以下情况，客户端和服务端需要关闭连接
    - 1 当对方宕机或者重启，主动关闭链路，另一方得知信号，也关闭连接，释放自身的句柄等资源。
    - 2 消息读写过程中，发送I/O异常，需要主动关闭连接
    - 3 心跳消息读写过程中发生I/O异常，需要主动关闭连接
    - 4 心跳超时，需要主动关闭连接
    - 5 发送编码异常等不可恢复错误，需要主动关闭连接 

### 12.2.9 可靠性设计
- 1 心跳机制，一旦发现网络故障，立即关闭链路，主动重连。
    - Ping-Pong双向心跳机制：
    - 1 当网络处于空闲状态维持时间达T（连续周期T没有读写消息），客户端主动发送Ping心跳消息给服务端。
    - 2 下个周期T到来，客户端还没有收到对方发送的Pong心跳应答消息，或者读取到服务端发送的其他业务消息，则心跳失败计数器加1。
    - 3 每当客户端接收到服务的业务消息或者Pong应答消息。将心跳失败计数器清零。连续N次没有接收到服务端的Pong消息或者业务消息，则关闭链路，间隔INTERVAL时间后，发起重连操作。
    - 4 服务端网络空闲状态维持时间达到T后，服务端将心跳失败计数器加1，只要接受到客户端发送额Ping消息或者其他业务消息，计数器清零。
    - 5 服务端连续N次没有接收到客户端的Ping消息或者其他业务消息，则关闭链路，释放资源，等待客户端重连。

-  当读或者写心跳消息发生IO异常，说明链路已经中断，此时需要立即关闭链路，
    - 如果是客户端，需要重新发起链接。
    - 如果是服务端，需要清空缓存的半包信息，等待客户端重连。

- 2 重连机制
    - 链路中断，等待INTERVAL时间，客户端发起重连操作，如果重连失败，间隔周期INTERVAL后再次发起重连，直到重连成功。
    - 间隔INTERVAL时间，保证服务端可以释放句柄资源。
    - 重连失败，客户端必须保证自身资源被及时释放，包括不限于SocketChannel,Socket等。
    - 重连失败后，需要打印异常堆栈信息，方便后续问题定位。
    
- 3 重复登录保护
    - 客户端握手成功后，在链路处于正常状态下，不允许客户端重复登录，以防止客户端在异常状态下反复重连导致句柄资源被后耗尽。
    - 服务端接收到客户端的握手请求消息之后，首先对IP地址进行合法性校验，如果校验成功，在缓存的地址列表中查看客户端是否已经登录，如果已经登录，则拒绝重复登录，返回错误码-1，同时关闭TCP链路，并在服务端的日志中打印握手失败原因。
    - 客户端接收到握手失败的应答消息之后，关闭客户端的TCP链接，等待INTERVAL时间之后，再次发起TCP链接，直到认证成功。
    - 为了防止由服务端和客户端对链路状态理解不一致导致的客户端无法握手成功的问题。当服务端连续N次心跳超时之后需要主动关闭链路，清空该客户端的地址缓存信息。以保证后续该客户可以重连成功。繁殖被重复登录保护机制拒绝掉。
    
 - 4 消息缓存重发
    - 无论客户端还是服务端，当发生链路中断之后，在链路恢复之前，缓存在消息队列中待发的消息不能丢失，等链路恢复之后，重新发送这些消息，保证链路中断期间消息不丢失。
    - 考虑到内存溢出的风险，建议消息缓存队列设置上限，当达到上限之后，应该拒绝继续向该队列添加新的消息。
    
### 12.2.10 安全性设计
- 示例：使用IP地址白名单的认证机制。
- 实际：使用基于密钥和AES加密的用户名+密码认证机制；SSL/TSL安全传输

### 12.2.11 可扩展性设计
- netty协议的扩展性：
    - 1 业务可以在消息头中自定义业务域字段： 消息流水号，业务自定义消息头等
    - 2 通过netty消息头中的可选附件attachment字段，可以扩展
- netty协议架构扩展：
    - 1 统一消息拦截，接口日志，安全，加解密等可以被方便地添加和删除。不需要修改之前的代码逻辑。类似Servlet的filter chain，AOP，AOP的性能问题不推介使用。

## 12.3 netty协议栈开发

### 12.3.1 数据结构定义
- NettyMessage
- Header
- NettyMessageEncoder extends MessageToMessageEncoder
- MarshallingEncoder
- NettyMessageDecoder extends LengthFieldBasedFrameDecoder
- MarshallingDecoders
- 握手和安全：LoginAuthReqHandler extends ChannelHandlerAdapter
- LoginAuthRespHandler extends ChannelHandlerAdapter
- 发送心跳请求消息：HearBeatReqHandler extends ChannelHandlerAdapter
- HearBeatRespHandler extends ChannelHandlerAdapter    
- 客户端：NettyClient
- 服务端：NettyServer
    

    
    
    
    
    
    
    
    
    
    
         